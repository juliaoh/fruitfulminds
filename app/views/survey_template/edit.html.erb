<% @subtitle = "Edit an existing survey template" %>
<script>
  $( document ).ready(function() {
    window.add_question = function(section_num, name, msg) {
      if (name == undefined) name = '';
      if (msg == undefined) msg = '';
      var num_sections = $("#num_sections").val();
      $numquestions = $('#snumquestions'+section_num);
      num_questions = parseInt($numquestions.val()) + 1;
      $numquestions.val(num_questions);
      var new_question = '<div id="q'+section_num+'_'+num_questions+'">Question Name <input name="s'+section_num+'q'+num_questions+'name'+'" id="squestion'+section_num+'_'+num_questions+'" /> <input type="button" id="delquestion'+section_num+'_'+num_questions+'" value="X" /><br />';
      new_question += 'Message:<br /><textarea id="s'+section_num+'q'+num_questions+'msg" name="s'+section_num+'q'+num_questions+'msg"></textarea><br />';
      var $question = $('td#squestion'+section_num);
      $question.append(new_question);
      $('#squestion'+section_num+'_'+num_questions).val(name);
      $('#s'+section_num+'q'+num_questions+'msg').val(msg);
      $('#delquestion'+section_num+'_'+num_questions).click({snum:section_num, qnum:num_questions}, function (e) {
        $('#q'+e.data.snum+'_'+e.data.qnum).remove();
      });
      $('#delsection'+section_num).click({snum:section_num}, function (e) {
        $('#s'+e.data.snum).remove();
      });
    };
    window.add_section = function(sname, stype, sobj) {
      if (sname == undefined) sname = ''
      if (stype == undefined) stype = 'Multiple Choice'
      if (sobj == undefined) sobj = ''
      $num_sections_field = $('#num_sections');
      $num_sections_field.val(parseInt($num_sections_field.val()) + 1);
      var num_sections = $num_sections_field.val();
      var content = '<div class="section" id="section'+num_sections+'">';
      content += '<input type="hidden" name="snumquestions'+num_sections+'" id="snumquestions'+num_sections+'" />';
      content += 'Section ';
      content += '<input type="button" id="delsection'+section_num'" value="X" /><br />';
      content += '<table id="section_data'+num_sections+'">';
      content += '<tr><td>Name</td><td><input name="sname'+num_sections+'" id="sname'+num_sections+'" /></td></tr>';
      content += '<tr><td>Type</td><td><select name="stype'+num_sections+'" id="stype'+num_sections+'"><option value="Multiple Choice">Multiple Choice</option><option value="Efficacy">Efficacy</option></select></td></tr>';
      content += '<tr><td>Objective</td><td><input name="sobjective'+num_sections+'" id="sobjective'+num_sections+'" /></td></tr>';
      content += '<tr><td colspan="2" style="height:15px;"></td></tr>';
      content += '<tr><td id="squestion'+num_sections+'" colspan="2"></td></tr>';
      content += '</table>';
      content += '<input type="button" name="add_question_btn'+num_sections+'" id="add_question_btn'+num_sections+'" value="Add Question" /><br />'
      content += '</div>';
      $('.form_content').append(content);
      $('#snumquestions'+num_sections).val(0);
      $('#stype'+num_sections).change({section_num:num_sections}, function (e) {
        if ($(this).val() == "mc") { $('#sobjective'+e.data.section_num).show(); }
        else { $('#sobjective'+e.data.section_num).hide(); }
      });
      $('#smsg'+num_sections).hide();
      $('#sname'+num_sections).val(sname);
      $('#stype'+num_sections).val(stype);
      $('#sobjective'+num_sections).val(sobj);
      $('input#add_question_btn'+num_sections).click(function () { add_question(num_sections); });
    };
    $('#add_section_btn').click(function () { add_section();});
    <% i = 1 %>
    <% @sections.each do |section| %>
        add_section("<%= section.name %>", "<%= section.stype %>", "<%= section.objective %>");
        <% section.questions.each do |question| %>
            add_question("<%= i %>", "<%= question.name %>", "<%= question.msg %>");
        <% end %>
        <% i += 1 %>
    <% end %>
    <% if @published %>
    $('textarea').attr('disabled', 'true');
    $('input').attr('disabled', 'true');
    <% end %>
  });
</script>
<style>
div.section {
  background:#FFFF99;
  margin:10px;
  border-radius:5px;
}
textarea {
  width:250px;
  height:65px;
}
</style>
<div style="width:400px; margin-left:auto; margin-right:auto">
    <form accept-charset="UTF-8" action="<%= survey_template_path(params[:id]) %>" method="post">
        <input name="_method" type="hidden" value="put">
        Survey Name<input id="surveyname" name="surveyname" value="<%= @survey_name %>" />
        <input type="hidden" name="num_sections" id="num_sections" value="0" />
        <div class="form_content"></div>
        <br /><input id="add_section_btn" type="button" value="Add Section" />
        <hr />
        <label><input type="checkbox" name="publish" id="publish" value="true" />Publish (THIS CANNOT BE UNDONE!!)</label>
        <br />
        <input type="submit" value="Save Changes" />
    </form>
</div>
